<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>sgmcmc: Getting Started • sgmcmc</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">sgmcmc</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="..//index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/sgmcmc.html">Get Started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/gaussMixture.html">Worked Example: Simulate from a Gaussian Mixture</a>
    </li>
    <li>
      <a href="../articles/logisticRegression.html">Worked Example: Logistic Regression</a>
    </li>
    <li>
      <a href="../articles/mvGauss.html">Worked Example: Simulate from a Multivariate Gaussian</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/STOR-i/sgmcmc">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>sgmcmc: Getting Started</h1>
                        <h4 class="author">Jack Baker</h4>
            
          </div>

    
    
<div class="contents">
<p>The goal of <code>sgmcmc</code> is to make it as easy as possible for users to run stochastic gradient MCMC (SGMCMC) algorithms. SGMCMC are algorithms which enable MCMC to scale more easily to large datasets, as traditional MCMC can run very slowly as dataset sizes grow.</p>
<p><code>sgmcmc</code> implements a lot of the popular stochastic gradient MCMC methods including <a href="http://people.ee.duke.edu/~lcarin/398_icmlpaper.pdf">SGLD</a>, <a href="https://arxiv.org/pdf/1402.4102v2.pdf">SGHMC</a> and <a href="http://papers.nips.cc/paper/5592-bayesian-sampling-using-stochastic-gradient-thermostats.pdf">SGNHT</a>. The package uses automatic differentiation, so all the differentiation needed for the methods is calculated automatically. Control variate methods can be used in order to improve the efficiency of the methods as proposed in the <a href="https://github.com/jbaker92/stochasticGradientMCMC">recent publication</a>. All users need to specify to run these algorithms is the data; the log likelihood and log prior; the parameter starting values; and a few tuning parameters.</p>
<p>To enable as much flexibility as possible, the data and parameter starting points fed to the functions in <code>sgmcmc</code> are specified as lists. This allows users to specify multiple parameters and datasets. It also allows the user to easily reference these quantities in the log likelihood and log prior, and to set different stepsizes for different paramters (essential when parameters are on different scales).</p>
<div id="specifying-the-data" class="section level3">
<h3 class="hasAnchor">
<a href="#specifying-the-data" class="anchor"></a>Specifying the Data</h3>
<p>As we mentioned earlier, the datasets you wish to use are specified as a list. Suppose we have datasets we have already obtained or created <code>X</code> and <code>Y</code>, we would specify the whole dataset for our session as</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dataset =<span class="st"> </span><span class="kw">list</span>(<span class="st">"X"</span> =<span class="st"> </span>X, <span class="st">"Y"</span> =<span class="st"> </span>Y)</code></pre></div>
<p>You can specify as many datasets as you like, the most important thing is that your naming is consistent, so you use the same names in your log likelihood and log prior functions, and in your list of stepsizes.</p>
<p>The functions assume that each observation is located on the first axis of the object. Suppose <code>Y</code> is a 2d matrix, then the observation <span class="math inline">\(Y_i\)</span> should be located at <code>dataset$Y[i,]</code>. Similarly if <code>X</code> is a 3d array, observation <span class="math inline">\(X_i\)</span> should be located at <code>dataset$X[i,,]</code>.</p>
</div>
<div id="specifying-the-parameters" class="section level3">
<h3 class="hasAnchor">
<a href="#specifying-the-parameters" class="anchor"></a>Specifying the Parameters</h3>
<p>Again parameters are specified as a list, the names are what we will refer to them as in the <code>logLik</code> and <code>logPrior</code> functions introduced below, the values are the desired starting points. Suppose my model depends on two parameter vectors <code>theta1</code> and <code>theta2</code>, and we want to start both from 0. If we assume both are length 3, this could be specified like this</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">params =<span class="st"> </span><span class="kw">list</span>(<span class="st">"theta1"</span> =<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>, <span class="dv">3</span>), <span class="st">"theta2"</span> =<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>, <span class="dv">3</span>))</code></pre></div>
</div>
<div id="specifying-the-log-likelihood-and-log-prior" class="section level3">
<h3 class="hasAnchor">
<a href="#specifying-the-log-likelihood-and-log-prior" class="anchor"></a>Specifying the Log Likelihood and Log Prior</h3>
<p>The log likelihood is specified as a function of the <code>dataset</code> and <code>params</code>, which have the same names as the lists you just specified. The only difference is that the objects inside the lists will have automatically been converted to TensorFlow objects for you. The <code>dataset</code> list will contain TensorFlow placeholders. The <code>params</code> list will contain TensorFlow variables. The <code>logLik</code> function should be a function that takes these lists as input and returns what the log likelihood value should be given the current parameter and data values. It should do this using TensorFlow operations. More details about how TensorFlow works can be found <a href="https://tensorflow.rstudio.com/">here</a>.</p>
<p>The log prior is specified in exactly the same way except that the function should only take <code>params</code> as input, as a prior should be independent of the dataset. You do not have to specify the prior at all, and this leads to the algorithm using a uniform, uninformative prior.</p>
<p>Suppose we want to simulate from the mean of a multivariate Normal density with each component of the mean having a Student T prior, we would specify this as follows</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(MASS)
<span class="co"># Simulate and declare dataset</span>
dataset =<span class="st"> </span><span class="kw">list</span>(<span class="st">"X"</span> =<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/MASS/topics/mvrnorm">mvrnorm</a></span>(<span class="dv">10</span>^<span class="dv">4</span>, <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="kw">diag</span>(<span class="dv">2</span>)))
<span class="co"># Simulate random starting point</span>
params =<span class="st"> </span><span class="kw">list</span>(<span class="st">"theta"</span> =<span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">2</span>))

<span class="co"># Declare log likelihood</span>
logLik =<span class="st"> </span>function(params, dataset) {
    <span class="co"># Declare distribution, assuming Sigma known and constant</span>
    SigmaDiag =<span class="st"> </span><span class="kw">c</span>( <span class="dv">1</span>, <span class="dv">1</span> )
    distn =<span class="st"> </span>tf$contrib$distributions$<span class="kw">MultivariateNormalDiag</span>(params$theta, SigmaDiag)
    <span class="co"># Return sum of log pdf</span>
    <span class="kw">return</span>(tf$<span class="kw">reduce_sum</span>(distn$<span class="kw">log_prob</span>(dataset$X)))
}

<span class="co"># Declare log prior</span>
logPrior =<span class="st"> </span>function(params) {
    <span class="co"># Declare prior distribution</span>
    distn =<span class="st"> </span>tf$contrib$distributions$<span class="kw">StudentT</span>(<span class="dv">3</span>, <span class="dv">0</span>, <span class="dv">1</span>)
    <span class="co"># Apply log prior componentwise and return sum</span>
    <span class="kw">return</span>(tf$<span class="kw">reduce_sum</span>(distn$<span class="kw">log_prob</span>(params$theta)))
}</code></pre></div>
<p>Most of the time just specifying the constants in these functions, such as <code>SigmaDiag</code> as <code>R</code> objects will be fine. But there are sometimes issues when these constants get automatically converted to <code>tf$float64</code> objects by <code>TensorFlow</code> rather than <code>tf$float32</code>. If you run into errors involving <code>tf$float64</code> then force the constants to be input as <code>tf$float32</code> by using <code>SigmaDiag = tf$constant( c( 1, 1 ), dtype = tf$float32 )</code>.</p>
</div>
<div id="specifying-the-tuning-parameters" class="section level3">
<h3 class="hasAnchor">
<a href="#specifying-the-tuning-parameters" class="anchor"></a>Specifying the Tuning Parameters</h3>
<p>The only other input that needs to be specified to set any of the standard stochastic gradient MCMC methods running is the <code>stepsize</code>. This is normally defined as a list with an entry for each parameter name as follows</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">stepsize =<span class="st"> </span><span class="kw">list</span>( <span class="st">"theta = 1e-5"</span> )</code></pre></div>
<p>A short hand is just to set <code>stepsize = 1e-5</code> which just sets the stepsize of each parameter to be <code>1e-5</code>. This shorthand can be used for any of the tuning constants.</p>
<p>So to get <code>sgld</code> working for the multivariate normal log likelihood we specified and an uninformative uniform prior we can simply run</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/sgld.html">sgld</a></span>( logLik, dataset, params, stepsize )</code></pre></div>
<p>similarly for <code>sghmc</code> and <code>sgnht</code>.</p>
<p>To use the Student t prior we specified and set a minibatch size of <code>500</code> we’d use</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/sgld.html">sgld</a></span>( logLik, dataset, params, stepsize, <span class="dt">logPrior =</span> logPrior, <span class="dt">minibatchSize =</span> <span class="dv">500</span> )</code></pre></div>
<p>For more details of the other optional arguments see the main documentation in the <a href="https://stor-i.github.io/sgmcmc/reference/index.html">reference</a>.</p>
<p>Any of the <a href="https://arxiv.org/pdf/1706.05439.pdf">control variate methods</a> <code>sgldcv</code>, <code>sghmccv</code> and <code>sgnhtcv</code> require an extra input <code>optStepsize</code>, which is the stepsize tuning constant for the initial optimization to find the MAP estimates. This argument is simply a small numeric value, such as <code>0.1</code>, and may require some tuning, which we talk about below. To run <code>sgldcv</code> on the multivariate normal model, with specified prior we’d use</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">optStepsize =<span class="st"> </span><span class="fl">0.1</span>
<span class="kw"><a href="../reference/sgldcv.html">sgldcv</a></span>( logLik, dataset, params, stepsize, optStepsize, <span class="dt">logPrior =</span> logPrior, <span class="dt">minibatchSize =</span> <span class="dv">500</span> )</code></pre></div>
<p>similar for <code>sghmccv</code> and <code>sgnhtcv</code>.</p>
<p>Most of the time, parameters need tuning, we suggest doing this using cross validation. You can roughly check the algorithm is converging by inspection by checking that the <code>Log posterior estimate</code> output by the algorithm settles down eventually (it should decrease at first unless the chain converges very quickly).</p>
</div>
<div id="next-steps" class="section level3">
<h3 class="hasAnchor">
<a href="#next-steps" class="anchor"></a>Next Steps</h3>
<p>We suggest for more details you read the worked examples in the Articles section, these cover a variety of models (which will be expanded as the package matures): - <a href="https://stor-i.github.io/sgmcmc///articles/mvGauss.html">Multivariate Gaussian</a> - <a href="https://stor-i.github.io/sgmcmc///articles/gaussMixture.html">Gaussian Mixture</a> - <a href="https://stor-i.github.io/sgmcmc///articles/logisticRegression.html">Logistic Regression</a></p>
<p>Full details of the API can be found <a href="https://stor-i.github.io/sgmcmc///reference/index.html">here</a>.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by <a href="http://lancs.ac.uk/~bakerj1/">Jack Baker</a>, <a href="http://www.lancs.ac.uk/~nemeth/">Christopher Nemeth</a>, <a href="http://www.maths.lancs.ac.uk/~fearnhea/">Paul Fearnhead</a>, <a href="https://homes.cs.washington.edu/~ebfox/">Emily B. Fox</a>, <a href="http://www.stor-i.lancs.ac.uk/"><img src="http://www.stor-i.lancs.ac.uk/MediaGallery/9-144.jpg" height="18"></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
