<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>sgmcmc: Getting Started • sgmcmc</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">sgmcmc</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="..//index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/sgmcmc.html">Get Started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/gaussMixture.html">Worked Example: Simulate from a Gaussian Mixture</a>
    </li>
    <li>
      <a href="../articles/logisticRegression.html">Worked Example: Logistic Regression</a>
    </li>
    <li>
      <a href="../articles/mvGauss.html">Worked Example: Simulate from a Multivariate Gaussian</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/STOR-i/sgmcmc">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>sgmcmc: Getting Started</h1>
                        <h4 class="author">Jack Baker</h4>
            
          </div>

    
    
<div class="contents">
<p>The goal of <code>sgmcmc</code> is to make it as easy as possible for users to run stochastic gradient MCMC (SGMCMC) algorithms. SGMCMC are algorithms which enable MCMC to scale more easily to large datasets, as traditional MCMC can run very slowly as dataset sizes grow.</p>
<p><code>sgmcmc</code> implements a lot of the popular stochastic gradient MCMC methods including <a href="http://people.ee.duke.edu/~lcarin/398_icmlpaper.pdf">SGLD</a>, <a href="https://arxiv.org/pdf/1402.4102v2.pdf">SGHMC</a> and <a href="http://papers.nips.cc/paper/5592-bayesian-sampling-using-stochastic-gradient-thermostats.pdf">SGNHT</a>. The package uses automatic differentiation, so all the differentiation needed for the methods is calculated automatically. Control variate methods can be used in order to improve the efficiency of the methods as proposed in the <a href="https://github.com/jbaker92/stochasticGradientMCMC">recent publication</a>. All users need to specify to run these algorithms is the data; the log likelihood and log prior; the parameter starting values; and a few tuning parameters.</p>
<p>To enable as much flexibility as possible, the data and parameter starting points fed to the functions in <code>sgmcmc</code> are specified as lists. This allows users to specify multiple parameters and datasets. It also allows the user to easily reference these quantities in the log likelihood and log prior, and to set different stepsizes for different paramters (essential when parameters are on different scales).</p>
<div id="specifying-the-data" class="section level3">
<h3 class="hasAnchor">
<a href="#specifying-the-data" class="anchor"></a>Specifying the Data</h3>
<p>As we mentioned earlier, the datasets you wish to use are specified as a list. Suppose we have datasets we have already obtained or created <code>X</code> and <code>y</code>, we would specify the whole dataset for our session as</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dataset =<span class="st"> </span><span class="kw">list</span>(<span class="st">"X"</span> =<span class="st"> </span>X, <span class="st">"Y"</span> =<span class="st"> </span>Y)</code></pre></div>
<p>You can specify as many datasets as you like, the most important thing is that your naming is consistent, so you use the same names in your log likelihood and log prior functions.</p>
<p>The functions assume that each observation is located on the first axis of the object. Suppose <code>Y</code> is a 2d matrix, then the observation <span class="math inline">\(Y_i\)</span> should be located at <code>dataset$Y[i,]</code>. Similarly if <code>X</code> is a 3d array, observation <span class="math inline">\(X_i\)</span> should be located at <code>dataset$X[i,,]</code>.</p>
</div>
<div id="specifying-the-parameters" class="section level3">
<h3 class="hasAnchor">
<a href="#specifying-the-parameters" class="anchor"></a>Specifying the Parameters</h3>
<p>Again to specify parameters, we simply set what we want their starting points to be. Suppose my model depends on two parameter vectors <code>theta1</code> and <code>theta2</code>, and we want to start both from 0. If we assume both are length 3, this could be specified like this</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">params =<span class="st"> </span><span class="kw">list</span>(<span class="st">"theta1"</span> =<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>, <span class="dv">3</span>), <span class="st">"theta2"</span> =<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>, <span class="dv">3</span>))</code></pre></div>
</div>
<div id="specifying-the-log-likelihood-and-log-prior" class="section level3">
<h3 class="hasAnchor">
<a href="#specifying-the-log-likelihood-and-log-prior" class="anchor"></a>Specifying the Log Likelihood and Log Prior</h3>
<p>The log likelihood is specified as a function of the <code>dataset</code> and <code>params</code>, which have the same names as the lists you just specified. The only difference is that the objects inside the lists will have automatically been converted to TensorFlow objects for you. The <code>dataset</code> list will contain TensorFlow placeholders. The <code>params</code> list will contain TensorFlow variables. The <code>logLik</code> function should be a function that takes these lists as input and returns what the log likelihood value should be given the current parameter and data values. It should do this using TensorFlow operations. More details about how TensorFlow works can be found <a href="https://tensorflow.rstudio.com/">here</a>. Note if you define constants inside the <code>logLik</code> function, please specify them as 32-bit (so <code>tf$float32</code> or <code>tf$int32</code>), as the <code>R</code> type system does not play nicely with the TensorFlow type system.</p>
<p>The log prior is specified in exactly the same way except that the function should only take <code>params</code> as input, as a prior should be independent of the dataset.</p>
<p>Suppose we want to simulate from the mean of a multivariate Normal density with each component of the mean having a Student T prior, we would specify this as follows</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(MASS)
<span class="co"># Simulate and declare dataset</span>
dataset =<span class="st"> </span><span class="kw">list</span>(<span class="st">"X"</span> =<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/MASS/topics/mvrnorm">mvrnorm</a></span>(<span class="dv">10</span>^<span class="dv">4</span>, <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="kw">diag</span>(<span class="dv">2</span>)))
<span class="co"># Simulate random starting point</span>
params =<span class="st"> </span><span class="kw">list</span>(<span class="st">"theta"</span> =<span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">2</span>))

<span class="co"># Declare log likelihood</span>
logLik =<span class="st"> </span>function(params, dataset) {
    <span class="co"># Declare distribution, assuming Sigma known and constant</span>
    distn =<span class="st"> </span>tf$contrib$distributions$<span class="kw">MultivariateNormalDiag</span>(params$theta, tf$<span class="kw">constant</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="dt">dtype =</span> tf$float32))
    <span class="co"># Return sum of log pdf</span>
    <span class="kw">return</span>(tf$<span class="kw">reduce_sum</span>(distn$<span class="kw">log_prob</span>(dataset$X)))
}

<span class="co"># Declare log prior</span>
logPrior =<span class="st"> </span>function(params) {
    <span class="co"># Declare prior distribution</span>
    distn =<span class="st"> </span>tf$contrib$distributions$<span class="kw">StudentT</span>(<span class="dv">3</span>, <span class="dv">0</span>, <span class="dv">1</span>)
    <span class="co"># Apply log prior componentwise and return sum</span>
    <span class="kw">return</span>(tf$<span class="kw">reduce_sum</span>(distn$<span class="kw">log_prob</span>(params$theta)))
}</code></pre></div>
</div>
<div id="specifying-the-tuning-parameters" class="section level3">
<h3 class="hasAnchor">
<a href="#specifying-the-tuning-parameters" class="anchor"></a>Specifying the Tuning Parameters</h3>
<p>Apart from the minibatch size (<span class="math inline">\(n\)</span>) and the number of iterations, the tuning parameters will be a list with the same names as <code>params</code>. This allows you to specify different stepsizes for different parameters – vital if they are on different scales. Note that if you are using the control variate algorithms, the tuning parameter <code>optStepsize</code> will also not be a list, this is because we use the standard TensorFlow ADAM optimizer in order to find the MAP estimates. So for example if you wanted to simulate from the previous example using <code>sgldcv</code>, so <a href="https://arxiv.org/pdf/1706.05439.pdf">stochastic gradient Langevin dynamics with control variates</a>, then you might set the tuning parameters as follows</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">stepsize =<span class="st"> </span><span class="kw">list</span>( <span class="st">"theta"</span> =<span class="st"> </span><span class="fl">1e-5</span> )
optStepsize =<span class="st"> </span><span class="fl">1e-1</span>
n =<span class="st"> </span><span class="dv">100</span></code></pre></div>
<p>The <code>stepsize</code> here are the stepsize parameters that SGLD will use, the <code>optStepsize</code> is the stepsize used for the initial optimization procedure that SGLDCV uses to find the MAP estimates.</p>
<p>Once the parameters are declared you can set <code>sgldcv</code> running using</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/sgldcv.html">sgldcv</a></span>(logLik, logPrior, dataset, params, stepsize, optStepsize, n, <span class="dt">nIters =</span> <span class="dv">10</span>^<span class="dv">4</span>, <span class="dt">nItersOpt =</span> <span class="dv">10</span>^<span class="dv">4</span>)</code></pre></div>
<p>The optional parameters here are simply <code>nIters</code> which is the number of iterations to run SGLD for and <code>nItersOpt</code>, the number of iterations in the optimization step.</p>
<p>Most of the time, parameters need tuning, we suggest doing this using cross validation. You can roughly check the algorithm is converging by inspection by checking that the <code>Log posterior estimate</code> output by the algorithm settles down eventually (it should decrease at first unless the chain converges very quickly).</p>
</div>
<div id="next-steps" class="section level3">
<h3 class="hasAnchor">
<a href="#next-steps" class="anchor"></a>Next Steps</h3>
<p>We suggest for more details you read the worked examples in the Articles section, these cover a variety of models (which will be expanded as the package matures): - <a href="https://stor-i.github.io/sgmcmc///articles/mvGauss.html">Multivariate Gaussian</a> - <a href="https://stor-i.github.io/sgmcmc///articles/gaussMixture.html">Gaussian Mixture</a> - <a href="https://stor-i.github.io/sgmcmc///articles/logisticRegression.html">Logistic Regression</a></p>
<p>Full details of the API can be found <a href="https://stor-i.github.io/sgmcmc///reference/index.html">here</a></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by <a href="http://lancs.ac.uk/~bakerj1/">Jack Baker</a>, <a href="http://www.lancs.ac.uk/~nemeth/">Christopher Nemeth</a>, <a href="http://www.maths.lancs.ac.uk/~fearnhea/">Paul Fearnhead</a>, <a href="https://homes.cs.washington.edu/~ebfox/">Emily B. Fox</a>, <a href="http://www.stor-i.lancs.ac.uk/"><img src="http://www.stor-i.lancs.ac.uk/MediaGallery/9-144.jpg" height="18"></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
